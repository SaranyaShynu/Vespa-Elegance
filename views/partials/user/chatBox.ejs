<div id="chatContainer" style="position: fixed; bottom: 80px; right: 20px; width: 300px; height: 400px; border: 1px solid #ccc; background: #fff; display: none; z-index: 1000; box-shadow: 0 0 10px rgba(0,0,0,0.2);
    border-radius: 10px;
    overflow: hidden;">
  <div id="chatBox" style="height: 350px; overflow-y: scroll; padding: 10px;"></div>
   <div style="display: flex; padding: 5px; border-top: 1px solid #ccc;">
    <input type="text" id="messageInput" placeholder="Type message" style="width: 80%;">
    <button id="sendBtn" type="button">Send</button>
  </div>
</div>

<button id="openChatBtn" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 50;   /* Always above chat container */
    background: #007bff;
    color: #fff;
    border: none;
    padding: 12px 16px;
    border-radius: 50%;
    cursor: pointer;
">Chat</button>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  <% if(user) { %>
    const roomId = "<%= user._id %>";
    const senderId = "<%= user._id %>";
    const senderName = "<%= user.name %>";
    socket.emit('joinRoom', roomId);
  <% } else { %>
    const roomId = null;
    const senderId = null;
    const senderName = "Guest";
  <% } %>

  // Receive messages
  socket.on('chat message', (msg) => {
    const chatBox = document.getElementById('chatBox');
    const align = msg.isFromAdmin ? 'left' : 'right';
    const name = msg.isFromAdmin ? 'Admin' : msg.senderName;
    chatBox.innerHTML += `<p style="text-align:${align}"><strong>${name}:</strong> ${msg.content}</p>`;
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  // Send message
  document.getElementById('sendBtn').addEventListener('click', () => {
    const input = document.getElementById('messageInput');
    const msg = input.value;
    if(!msg.trim()) return;

    socket.emit('chat message', { 
      roomId, 
      content: msg, 
      sender: senderId, 
      senderName:"<%= user ? user.name : '' %>",
      isFromAdmin: false 
    });

    input.value = '';
  });

  // Open chat window
  const chatContainer = document.getElementById('chatContainer');
  const openChatBtn = document.getElementById('openChatBtn');

  openChatBtn.addEventListener('click', () => {
    chatContainer.style.display = 'block';
    openChatBtn.style.display = 'none';
  });
</script>
