<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout - Vespa Elegance</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container my-5">
  <h2>Checkout</h2>



  <!-- Shipping Address -->
  <div class="mb-4">
    <h4>Shipping Address</h4>
    <select name="selectedAddress" id="addressSelect" class="form-select mb-2">
      <% if (addresses && addresses.length > 0) { %>
        <% addresses.forEach((addr, i) => { %>
          <option value="<%= i %>" <%= i === selectedAddressIndex ? 'selected' : '' %>>
            <%= addr.street %>, <%= addr.city %>, <%= addr.state %>, <%= addr.country %> - <%= addr.zip %>
          </option>
        <% }) %>
      <% } else { %>
        <option disabled selected>No saved addresses</option>
      <% } %>
    </select>

    <!-- Optional Alternative Address -->
    <a href="/user/profile/edit" class="btn btn-outline-secondary mb-3">Add/Change Address</a>

    <!-- Add Address Form (collapsible) -->
    <div class="collapse" id="addAddressForm">
      <form action="/profile/add-address" method="POST" class="mb-3">
        <input type="text" name="street" placeholder="Street" required class="form-control mb-2">
        <input type="text" name="city" placeholder="City" required class="form-control mb-2">
        <input type="text" name="state" placeholder="State" required class="form-control mb-2">
        <input type="text" name="country" placeholder="Country" required class="form-control mb-2">
        <input type="text" name="zip" placeholder="Zip Code" required class="form-control mb-2">
        <input type="text" name="phone" placeholder="Phone" required class="form-control mb-2">
        <button type="submit" class="btn btn-primary">Add Address</button>
      </form>
    </div>
  </div>

  <!-- Order Summary -->
  <h4>Order Summary</h4>
  <form id="checkoutForm" action="/user/checkout/place-order" method="POST">
    <input type="hidden" name="selectedAddress" id="selectedAddressHidden" value="<%= selectedAddressIndex %>">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Product</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        <% let subtotal = 0; %>
        <% cart.items.forEach(item => { %>
          <% let itemTotal = item.productId.price * item.quantity; %>
          <% subtotal += itemTotal; %>
          <tr>
            <td><%= item.productId.name %></td>
            <td><%= item.quantity %></td>
            <td>₹<%= item.productId.price %></td>
            <td>₹<%= itemTotal %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <!-- Coupon -->
    <div class="mb-3">
      <label for="couponSelect" class="form-label">Apply Coupon</label>
      <select name="couponCode" id="couponSelect" class="form-select">
        <option value="">-- Select Coupon --</option>
        <% coupons.forEach(c => { %>
          <% let expired = new Date(c.expiredOn) < new Date(); %>
          <% let used = c.usedBy.includes(user._id.toString()); %>
          <option value="<%= c.code %>" <%= expired || used ? 'disabled' : '' %>>
            <%= c.code %> - <%= c.discountType === 'percentage' ? c.discountValue + '%' : '₹' + c.discountValue %>
            <%= expired ? '(Expired)' : '' %>
            <%= used ? '(Used)' : '' %>
          </option>
        <% }) %>
      </select>
    </div>

    <!-- Subtotal / Discount / Final -->
    <div class="mb-3">
      <p>Subtotal: ₹<span id="subtotal"><%= subtotal %></span></p>
      <p>Discount: ₹<span id="discount">0</span></p>
      <p><strong>Final Price: ₹<span id="finalPrice"><%= subtotal %></span></strong></p>
    </div>

    <input type="hidden" name="finalPrice" id="finalPriceHidden" value="<%= subtotal %>">

    <!-- Payment Method -->
    <div class="mb-3">
      <label class="form-label">Payment Method</label>
      <select name="paymentMethod" id="paymentMethod" class="form-select" required>
        <option value="COD">Cash on Delivery</option>
        <option value="Online">Online Payment</option>
      </select>
    </div>

    <button type="submit" class="btn btn-success w-100">Place Order</button>
  </form>
</div>

<script>
  // Coupon calculation
  const coupons = <%- JSON.stringify(coupons) %>;
  const userId = '<%= user._id %>';
  const couponSelect = document.getElementById('couponSelect');
  const subtotalElem = document.getElementById('subtotal');
  const discountElem = document.getElementById('discount');
  const finalPriceElem = document.getElementById('finalPrice');
  const finalPriceHidden = document.getElementById('finalPriceHidden');

  couponSelect.addEventListener('change', () => {
    let selected = couponSelect.value;
    let subtotal = parseFloat(subtotalElem.textContent);
    let discount = 0;

    if (selected) {
      let coupon = coupons.find(c => c.code === selected);
      if (coupon) {
        let expired = new Date(coupon.expiredOn) < new Date();
        let used = coupon.usedBy.includes(userId);
        if (!expired && !used) {
          discount = coupon.discountType === 'percentage'
            ? subtotal * (coupon.discountValue / 100)
            : coupon.discountValue;
        }
      }
    }

    discountElem.textContent = discount.toFixed(2);
    let finalPrice = subtotal - discount;
    finalPriceElem.textContent = finalPrice.toFixed(2);
    finalPriceHidden.value = finalPrice.toFixed(2);
  });

  // Update hidden selectedAddress on change
  const addressSelect = document.getElementById('addressSelect');
  const addressHidden = document.getElementById('selectedAddressHidden');
  addressSelect.addEventListener('change', () => {
    addressHidden.value = addressSelect.value;
  });
</script>
</body>
</html>
