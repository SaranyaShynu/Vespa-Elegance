<!DOCTYPE html>
<html lang="en">
<head>
  <title><%= model.name %> - Vespa Elegance</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mukta:300,400,700">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">

  <style>
    body { background-color: #f8f9fa; font-family: 'Mukta', sans-serif; }
    h2, h4, h5 { font-weight: 600; }

    .model-image { width: 100%; height: 380px; overflow: hidden; border-radius: 12px; }
    .model-image img { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }

    .selectable-color {
      width: 35px; height: 35px; border-radius: 50%;
      margin-right: 10px; border: 2px solid transparent;
      cursor: pointer; transition: transform 0.2s, border 0.2s;
    }
    .selectable-color:hover { transform: scale(1.1); border: 2px solid #999; }
    .selectable-color.selected {
      border: 3px solid #007bff; box-shadow: 0 0 8px rgba(0,123,255,0.6);
    }

    .review-card {
      background: #fff; border-radius: 8px; padding: 15px 18px;
      margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .rating-section { border-top: 1px solid #e0e0e0; margin-top: 25px; padding-top: 20px; }

    .star-rating { direction: rtl; display: inline-flex; font-size: 1.6rem; cursor: pointer; }
    .star-rating input { display: none; }
    .star-rating label { color: #bbb; transition: color 0.2s; }
    .star-rating input:checked ~ label { color: #ffc107; }
    .star-rating label:hover,
    .star-rating label:hover ~ label { color: #ffdb58; }

    .text-dark-bold { color: #212529; font-weight: 600; }
    .text-danger { color: #dc3545; }
    .text-success { color: #28a745; }
  </style>
</head>

<body>
<div class="site-wrap">

  <%- include("../partials/user/header") %>

  <!-- Breadcrumb -->
  <div class="bg-light py-3">
    <div class="container">
      <a href="/" class="text-decoration-none text-dark">Home</a>
      <span class="mx-2">/</span>
      <strong class="text-black">Details</strong>
    </div>
  </div>

  <!-- Product Section -->
  <div class="container my-5">
    <div class="row g-4 align-items-start">

      <!-- Left: Image Carousel -->
      <div class="col-md-7">
        <div id="carouselIndicators" class="carousel slide" data-ride="carousel">
          <div class="carousel-inner">
            <% if (model.images && model.images.length > 0) { %>
              <% model.images.forEach(function(img, index) { %>
                <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                  <div class="model-image">
                    <img src="/images/<%= img %>" class="d-block w-100" alt="Model Image">
                  </div>
                </div>
              <% }) %>
            <% } %>
          </div>
          <a class="carousel-control-prev" href="#carouselIndicators" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </a>
          <a class="carousel-control-next" href="#carouselIndicators" role="button" data-slide="next">
            <span class="carousel-control-next-icon"></span>
          </a>
        </div>
      </div>

      <!-- Right: Model Details -->
      <div class="col-md-5">
        <h2><%= model.name %></h2>
        <p class="mb-1"><span class="text-dark-bold">Category:</span> <%= model.category || 'N/A' %></p>
        <p class="h4 text-primary mb-3">₹ <%= model.price %></p>

        <!-- Colors -->
        <h5>Available Colors:</h5>
        <div class="d-flex align-items-center flex-wrap mb-2" id="color-options">
          <% if (model.color && model.color.length) { %>
            <% model.color.forEach(function(c){ %>
              <span class="selectable-color" data-color="<%= c %>" style="background-color:<%= c %>;"></span>
            <% }) %>
          <% } else { %>
            <p>No colors available</p>
          <% } %>
          <span class="ml-3 px-2 py-1 rounded"
                style="background-color: <%= model.status === 'Available' ? '#28a745' : '#dc3545' %>; color:white; font-weight:bold;">
            <%= model.status %>
          </span>
        </div>
        <input type="hidden" id="selectedColor" name="selectedColor" value="">

        <!-- Average Rating -->
        <p>⭐ Average Rating: <strong><%= model.averageRating %></strong> / 5 (<%= model.ratings.length %> reviews)</p>

        <!-- Add to Cart / Buy Now -->
        <form action="/cart/add" method="POST" class="mt-3">
          <input type="hidden" name="productId" value="<%= model._id %>">
          <input type="hidden" name="price" value="<%= model.price %>">
          <input type="hidden" id="colorInput" name="color" value="">
          <button type="submit" class="btn btn-primary btn-lg w-100">Add to Cart</button>
        </form>
        <form action="/buy-now/checkout/<%= model._id %>" method="GET" class="mt-3">
          <input type="hidden" name="productId" value="<%= model._id %>">
          <input type="hidden" name="quantity" value="1">
          <input type="hidden" name="selectedAddress" value="0">
          <button type="submit" class="btn btn-success btn-lg mt-2">Buy Now</button>
        </form>

        <!-- Rating + Review -->
        <div class="rating-section">
          <% if (isLoggedIn) { %>
            <div class="star-rating mb-2" id="starRating" data-model-id="<%= model._id %>">
              <% for (let i = 5; i >= 1; i--) { %>
                <input type="radio" id="star<%= i %>" name="rating" value="<%= i %>">
                <label for="star<%= i %>">★</label>
              <% } %>
            </div>
            <div class="review-form">
              <textarea id="reviewText" rows="3" class="form-control" placeholder="Write a review (optional)"></textarea>
              <button class="btn btn-primary mt-2" id="submitReview">Submit Review</button>
              <p id="rating-msg" class="mt-2"></p>
            </div>
          <% } else { %>
            <p class="text-muted mt-3">Login to rate and review this product.</p>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Reviews -->
    <div class="row mt-5">
      <div class="col-md-12">
        <h4>Customer Reviews</h4>
        <div id="reviewList" class="mt-3">
          <% if (model.ratings && model.ratings.length) { %>
            <% model.ratings.forEach(review => { %>
              <div class="review-card">
                <div class="d-flex justify-content-between">
                  <strong><%= review.userId ? review.userId.name || 'Anonymous' : 'Anonymous' %></strong>
                  <small><%= new Date(review.createdAt).toLocaleString() %></small>
                </div>
                <div>
                  <span>⭐ <%= review.rating || 0 %> / 5</span>
                  <% if (review.review) { %>
                    <p><%= review.review %></p>
                  <% } %>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-muted">No reviews yet.</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <%- include('../partials/user/footer') %>
</div>

<script src="/js/jquery-3.3.1.min.js"></script>
<script src="/js/bootstrap.min.js"></script>

<script>
  // Color selection
  const colorDots = document.querySelectorAll('.selectable-color');
  const selectedColorInput = document.getElementById('selectedColor');
  const colorInputHidden = document.getElementById('colorInput');

  colorDots.forEach(dot => {
    dot.addEventListener('click', () => {
      colorDots.forEach(d => d.classList.remove('selected'));
      dot.classList.add('selected');
      selectedColorInput.value = dot.dataset.color;
      colorInputHidden.value = dot.dataset.color;
    });
  });

  // Prevent Add to Cart without color
  const addToCartForm = document.querySelector('form[action="/cart/add"]');
  addToCartForm.addEventListener('submit', (e) => {
    if (!selectedColorInput.value) {
      e.preventDefault();
      alert("Please select a color before adding to cart.");
    }
  });

  // ⭐ Instant star rating submission
  document.querySelectorAll('.star-rating input').forEach(radio => {
    radio.addEventListener('change', async (e) => {
      const rating = e.target.value;
      const modelId = document.getElementById('starRating').dataset.modelId;

      try {
        const res = await fetch('/model/rate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ modelId, rating })
        });
        const data = await res.json();
        const msg = document.getElementById('rating-msg');
        if (data.success) {
          msg.textContent = '⭐ Rating submitted!';
          msg.className = 'text-success mt-2';
        } else {
          msg.textContent = data.error || 'Error submitting rating';
          msg.className = 'text-danger mt-2';
        }
      } catch (err) {
        console.error(err);
      }
    });
  });

  // ✍️ Review submission
  document.getElementById('submitReview').addEventListener('click', async (e) => {
    e.preventDefault();

    const review = document.getElementById('reviewText').value.trim();
    const modelId = document.getElementById('starRating').dataset.modelId;

    if (!review) {
      const msg = document.getElementById('rating-msg');
      msg.textContent = 'Please write something before submitting.';
      msg.className = 'text-danger mt-2';
      return;
    }

    try {
      const res = await fetch('/model/review', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ modelId, review })
      });
      const data = await res.json();
      const msg = document.getElementById('rating-msg');

      if (data.success) {
        msg.textContent = '✅ Review submitted successfully!';
        msg.className = 'text-success mt-2';
        document.getElementById('reviewText').value = '';
        location.reload();
      } else {
        msg.textContent = data.error || 'Error submitting review';
        msg.className = 'text-danger mt-2';
      }
    } catch (err) {
      console.error(err);
      const msg = document.getElementById('rating-msg');
      msg.textContent = 'Server error.';
      msg.className = 'text-danger mt-2';
    }
  });
</script>
</body>
</html>
